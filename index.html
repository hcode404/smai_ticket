<div id="live-chat-window" class="fixed bottom-4 left-4 w-80 h-96 bg-slate-900 border border-blue-500 rounded-t-2xl shadow-2xl flex flex-col hidden z-50">
    <div class="bg-blue-600 p-3 rounded-t-2xl flex justify-between items-center">
        <span class="font-bold">צאט תמיכה SMAI</span>
        <button onclick="closeChat()" class="text-xl">×</button>
    </div>
    <div id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-2 text-sm">
        <div class="bg-slate-800 p-2 rounded text-slate-400 italic">ממתין לנציג SMAI...</div>
    </div>
    <div class="p-2 border-t border-slate-700 flex gap-2">
        <input type="text" id="chat-input" placeholder="הקלד הודעה..." class="flex-grow bg-slate-800 p-2 rounded outline-none text-xs">
        <button id="send-msg-btn" class="bg-blue-500 px-3 py-1 rounded">></button>
    </div>
</div>



<script type="module">
    // ... (המשך הקוד של Firebase מההודעה הקודמת) ...

    let currentChatId = null;

    window.handleTicket = async (method) => {
        const userName = document.getElementById('name').value || "אורח";
        const userIssue = document.getElementById('issue').value || "פנייה מהצאט";

        // יצירת מזהה ייחודי לחדר הצאט
        currentChatId = "chat_" + Date.now();

        await addDoc(collection(db, "smai_tickets"), {
            chatId: currentChatId,
            name: userName,
            message: userIssue,
            method: method,
            status: "open",
            time: serverTimestamp()
        });

        if (method === 'chat') {
            document.getElementById('live-chat-window').classList.remove('hidden');
            startChatListener(currentChatId);
        } else if (method === 'whatsapp') {
            window.open(`https://wa.me/972XXXXXXXXX?text=שלום SMAI, שמי ${userName}. ${userIssue}`);
        }
    };

    // שליחת הודעה בצאט
    document.getElementById('send-msg-btn').onclick = async () => {
        const text = document.getElementById('chat-input').value;
        if (!text || !currentChatId) return;

        await addDoc(collection(db, "chats", currentChatId, "messages"), {
            text: text,
            sender: "customer",
            time: serverTimestamp()
        });
        document.getElementById('chat-input').value = "";
    };

    // האזנה להודעות בחדר הצאט
    function startChatListener(chatId) {
        const q = query(collection(db, "chats", chatId, "messages"), orderBy("time", "asc"));
        onSnapshot(q, (snapshot) => {
            const msgContainer = document.getElementById('chat-messages');
            msgContainer.innerHTML = "";
            snapshot.forEach(doc => {
                const m = doc.data();
                const isMe = m.sender === "customer";
                msgContainer.innerHTML += `
                    <div class="${isMe ? 'text-left' : 'text-right'}">
                        <span class="inline-block p-2 rounded-lg ${isMe ? 'bg-blue-700' : 'bg-slate-700'} max-w-[80%]">
                            ${m.text}
                        </span>
                    </div>
                `;
            });
            msgContainer.scrollTop = msgContainer.scrollHeight;
        });
    }
</script>
